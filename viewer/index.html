<!DOCTYPE html>
<html lang="en">

<head>
  <title>Sample Point Cloud Viewer</title>
  <link rel="stylesheet" href="css/main.css">
  <script src="js/Cesium_Tiles/Cesium.js"></script>
  <script src="js/jquery-1.12.2.min.js"></script>
  <style>
    @import url(js/Cesium_Tiles/Widgets/widgets.css);
  </style>
</head>

<body>

  <div id="cesiumContainer"></div>

  <script>
    var dark_basemapProvider = new Cesium.UrlTemplateImageryProvider({
      url: 'http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png',
      credit: ''
    });
    var light_basemapProvider = new Cesium.UrlTemplateImageryProvider({
      url: 'http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
      credit: ''
    });
    var naturalEarth = new Cesium.TileMapServiceImageryProvider({
      url: '//cesiumjs.org/tilesets/imagery/naturalearthii'
    });

    var terrainProvider = new Cesium.CesiumTerrainProvider({
      url: '//assets.agi.com/stk-terrain/world'
    });

    Cesium.BingMapsApi.defaultKey = 'AoQ-ldid5Zpdn4YKoSfVLhF1kWycQXAAnH-KKGwBpxb7YfPPoP7F0T4GMJhVdLsU';

    var viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: light_basemapProvider,
      //imageryProvider: dark_basemapProvider,
      //imageryProvider: naturalEarth,
      terrainProvider: terrainProvider,
      baseLayerPicker: false,
      fullscreenButton: false,
      homeButton: false,
      timeline: false,
      navigationHelpButton: false,
      animation: false,
      scene3DOnly: true,
      geocoder: false
    });
    var scene = viewer.scene;

    document.body.onkeyup = function(e) {
      if (e.keyCode == 32) {
        console.log(window.viewer.camera);
      }
    }

    // custom viewer to view all lidar data
    window.viewer.camera.position = {
      x: -2505040.267327988,
      y: -3849579.8556679944,
      z: 4413232.863541417
    }

    window.viewer.camera.right = {
      x: 0.7697564190624282,
      y: 0.1956700897024687,
      z: 0.6076086497982189
    }

    window.viewer.camera.up = {
      x: -0.6383369044126985,
      y: 0.23748291737685143,
      z: 0.7322075255148646
    }

    window.viewer.camera.direction = {
      x: 0.0010255625791728473,
      y: 0.9514804674559364,
      z: -0.3077074394148404
    }

    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    var TIME = getParameterByName('TIME');

    load_tiles();

    function load_tiles() {

      var tileset;
      var tileList = [];

      // get the list of tiles
      $.get('https://d1r1mnth168hw3.cloudfront.net/pntgen/tiles/' + TIME + '_tiles.txt', function(d) {

        var tiles = d.split("\n");
        var tiles = tiles.filter(function(v) {
          return v !== ''
        });

        function loadTileset(i) {

          console.log(tiles[i])

          var url = 'https://d1r1mnth168hw3.cloudfront.net/pntgen/json/' + tiles[i] + '.json';
          console.log('loading ' + url)
          tileset = scene.primitives.add(new Cesium.Cesium3DTileset({
            url: url
          }));
          return Cesium.when(tileset.readyPromise).then(function(tileset) {
            var bounding = tileset._root._boundingVolume;
            var center = bounding.boundingSphere.center
            var cart = Cesium.Ellipsoid.WGS84.cartesianToCartographic(center);
            tileList.push(tileset);

            // uncomment this code to refresh the camera upon tile load 
            //viewer.camera.setView({
            //  destination: Cesium.Cartesian3.fromDegrees(cart.longitude * (180 / Math.PI), cart.latitude * (180 / Math.PI), 1000)
            //});

            if (i < tiles.length - 1) {
              loadTileset(i + 1)
            }
            else {
              console.log('tile load complete');
              
              /*    
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(cart.longitude * (180 / Math.PI), cart.latitude * (180 / Math.PI), 1000)
              });
              */
              // zoom to tiles
              /*
              var west = -90.0;
              var south = 38.0;
              var east = -87.0;
              var north = 40.0;
              var rectangle = Cesium.Rectangle.fromDegrees(west, south, east, north);
              
              viewer.camera.flyTo({
                  destination : rectangle
              });
              */

            }
          });
        }

        loadTileset(0);

      });

    }
  </script>
</body>

</html>
